<!DOCTYPE html>
<html>
<head>
  <title>Eye of the Storm - Debug Player</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body { background: #1a1a1a; color: #fff; font-family: monospace; }
    #video-container { width: 80%; margin: 20px auto; border: 1px solid #444; }
    video { width: 100%; }
    #metrics { padding: 20px; font-size: 12px; color: #0f0; }
    #errors { color: #f55; padding: 20px; font-size: 12px; border-top: 1px solid #444; }
  </style>
</head>
<body>
  <div id="video-container">
    <video id="video" controls></video>
  </div>
  <div id="metrics">
    <h3>Real-time Metrics</h3>
    <div id="stat_level">Current Level: Loading...</div>
    <div id="stat_bitrate">Bitrate: Loading...</div>
    <div id="stat_res">Resolution: Loading...</div>
  </div>

  <script>
    var video = document.getElementById('video');
    var apiEndpoint = 'https://api.toptal.miller.today/latest'

    function logError(msg) {
        var d = document.createElement('div');
        d.innerText = "[ERROR] " + msg;
        var container = document.getElementById('errors');
        if (container) container.appendChild(d);
        console.error(msg);
    }

    fetch(apiEndpoint) 
      .then(response => response.json())
      .then(data => {
        if (data.playbackUrl) {
          console.log("Loading latest video:", data.videoId);
          var videoSrc = data.playbackUrl;
          
          if (Hls.isSupported()) {
            var hls = new Hls({
              debug: true,
              capLevelToPlayerSize: false,
              maxBufferLength: 30,
            });

            hls.loadSource(videoSrc);
            hls.attachMedia(video);

            hls.on(Hls.Events.MANIFEST_PARSED, function() {
              var maxIndex = hls.levels.length - 1; 
              console.log("Found " + hls.levels.length + " levels. Max Index: " + maxIndex);
              hls.currentLevel = maxIndex;
              video.play();
            });
            hls.on(Hls.Events.LEVEL_SWITCHED, function(event, data) {
              var level = hls.levels[data.level];
              document.getElementById('stat_level').innerText = "Current Level Index: " + data.level;
              document.getElementById('stat_bitrate').innerText = "Bitrate: " + (level.bitrate / 1000).toFixed(0) + " kbps";
              document.getElementById('stat_res').innerText = "Resolution: " + level.width + "x" + level.height;
            });
            hls.on(Hls.Events.ERROR, function (event, data) {
                if (data.fatal) {
                    logError("Fatal error: " + data.type);
                }
                if (data.response && data.response.code >= 400) {
                    logError("Network Error: " + data.response.url + " (" + data.response.code + ")");
                }
            });
          }
        } else {
          console.error("No processed videos found.");
          document.body.innerHTML += "<h1>No videos found. Upload one first!</h1>";
        }
      })
      .catch(err => {
        console.error("API Error:", err);
      });
  </script>
</body>
</html>
